<template>
  <div>
    <div v-if="loading">
      <mwc-circular-progress indeterminate></mwc-circular-progress>
    </div>
    <div v-else>
      <div id="content" style="display: flex; flex-direction: column; flex: 1;">
        <h2>Welcome to Your App!</h2>
        <p>Below are the next steps to integrate the components generated by the scaffolding tool into your app:</p>
        <ol>
          <li>Locate the UI components in the <code>ui/src/DNA/ZOME</code> folders that were generated using commands like <code>hc scaffold entry-type</code>, <code>hc scaffold collection</code>, and <code>hc scaffold link-type</code>.</li>
          <li>Import these components into your <code>App.vue</code> file.</li>
          <li>Declare these imported components within the <code>components</code> section of your <code>App</code> component</li>
          <li>Replace the placeholder content in the <code>&lt;div id="content"&gt;</code> with the components you imported.</li>
        </ol>
      </div>
    {{#if holo_enabled}}
      <mwc-button
        v-if="IS_HOLO"
        style="margin-top: 16px"
        raised
        label="Logout"
        @click="logout" 
      />
    {{/if}}
    </div>
  </div>
</template>
<script lang="ts">
import { defineComponent, computed } from 'vue';
import { AppAgentClient, AppAgentWebsocket } from '@holochain/client';
{{#if holo_enabled}}
import WebSdk from '@holo-host/web-sdk';
import type { AgentState } from '@holo-host/web-sdk';
{{/if}}
import '@material/mwc-circular-progress';
import '@material/mwc-button';

export default defineComponent({
  components: {
    // Add your subcomponents here
  },
  data(): {
    client: AppAgentClient | undefined;
    loading: boolean;
  {{#if holo_enabled}}
    IS_HOLO: boolean;
  {{/if}}
  } {
    return {
      client: undefined,
      loading: true,
    {{#if holo_enabled}}
      IS_HOLO: ['true', '1', 't'].includes(import.meta.env.VITE_APP_IS_HOLO?.toLowerCase()),
    {{/if}}
    };
  },
  async mounted() {
  {{#if holo_enabled}}
    if (this.IS_HOLO) {
      const client: WebSdk = await WebSdk.connect({
        chaperoneUrl: import.meta.env.VITE_APP_CHAPERONE_URL,
        authFormCustomization: {
          appName: '{{app_name}}',
        }
      });

      client.on('agent-state', (agent_state: AgentState) => {
        this.loading = !agent_state.isAvailable || agent_state.isAnonymous
      });

      client.signUp({ cancellable: false });

      this.client = client
    } else {
      this.client = await AppAgentWebsocket.connect('{{app_name}}');
      this.loading = false;
    }
  {{else}}
    this.client = await AppAgentWebsocket.connect('{{app_name}}');
    this.loading = false;
  {{/if}}
  },
{{#if holo_enabled}}
  methods: {
    async logout () {
      await (this.client as WebSdk).signOut();
      await (this.client as WebSdk).signIn({ cancellable: false });
    }
  },
{{/if}}
  provide() {
    return {
      client: computed(() => this.client),
    };
  },
});
</script>
